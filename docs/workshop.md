# Мастерская
**В API мастерской находятся методы, позволяющие просматривать, создавать, изменять и удалять работы. Одним словом CRUD.**

---

## Битовые флаги (flags)

Многие эндпоинты возвращают поле `flags` — битовую маску, содержащую различные характеристики повязки:

| Бит | Значение | Описание                                               |
| --- | -------- | ------------------------------------------------------ |
| 0   | `1`      | `colorable` - Повязка окрашиваемая                     |
| 1   | `2`      | `split_type` - Разные изображения для slim/classic рук |
| 2   | `4`      | `starred` - Повязка в избранном текущего пользователя  |
| 3   | `8`      | `under_moderation` - Повязка на проверке               |
| 4   | `16`     | `denied` - Повязка отклонена модерацией                |

**Примеры:**
- `flags = 1` (0b00001) = colorable
- `flags = 3` (0b00011) = colorable + split_type
- `flags = 7` (0b00111) = colorable + split_type + starred

**Проверка флагов:**
```javascript
const isColorable = (flags & 1) !== 0;
const isSplitType = (flags & 2) !== 0;
const isStarred = (flags & 4) !== 0;
const isUnderModeration = (flags & 8) !== 0;
const isDenied = (flags & 16) !== 0;
```

---

## `GET /workshop`
Возвращает список доступных к просмотру работ в мастерской.

### Query параметры
| Имя      | Описание                                                 | Тип данных | Стандартное значение |
| -------- | -------------------------------------------------------- | ---------- | -------------------- |
| `take`   | Количество работ на одной странице.                      | `number`   | `20`                 |
| `page`   | Запрашиваемая страница.                                  | `number`   | `0`                  |
| `search` | Фрагмент названия/описания/id/имени автора для поиска.   | `string`   | `""`                 |
| `sort`   | Требуемый порядок сортировки. О возможных значениях ниже | `string`   | `""`                 |

Возможные значения для параметра сортировки:
- `relevant_up` — Сначала наиболее актуальные.
- `popular_up` — Сначала с наибольшим количеством звёзд.
- `date_up` — Сначала более новые.
- `name_up` — Сортировка по алфавиту.

### Особенности
> [!NOTE]
> Данный эндпоинт не требует обязательной аутентификации, однако токен сессии, переданный в cookies будет учтён при составлении списка работ (для определения starred статуса).

Данный эндпоинт исключает все повязки, проходящие или отклоненные модерацией, если повязка имеет доступ только по ссылке или если автор заблокирован на сайте.

### Возвращаемое значение

| Поле            | Описание                                                                                 | Тип данных                                |
| --------------- | ---------------------------------------------------------------------------------------- | ----------------------------------------- |
| `id`            | Внутренний инкрементальный id повязки в базе данных.                                     | `number`                                  |
| `external_id`   | Внешний id повязки. Используется в URL.                                                  | `string`                                  |
| `title`         | Заголовок повязки.                                                                       | `string`                                  |
| `description`   | Описание повязки.                                                                        | `string \| null`                          |
| `base64`        | Изображение повязки в формате `Base 64`. Префикс `data:image/png;base64,` не передается. | `string`                                  |
| `flags`         | Битовая маска характеристик повязки ([подробнее](#битовые-флаги-flags))                  | `number`                                  |
| `accent_color`  | Акцентный цвет повязки в формате HEX                                                     | `string`                                  |
| `creation_date` | Время создания повязки.                                                                  | `Date` as string                          |
| `stars_count`   | Количество пользователей, добавивших повязку в избранное                                 | `number`                                  |
| `tags`          | Массив имен тегов повязки.                                                               | `string[]`                                |
| `author`        | Профиль автора повязки.                                                                  | [`Author`](#объект-автора-повязки)        |
| `access_level`  | Общий уровень доступа к повязке в мастерской.                                            | `number`                                  |
| `star_type`     | Тип звезды, отображаемый в мастерской                                                    | `number`                                  |
| `moderation`    | Состояние модерации                                                                      | [`Moderation \| null`](#объект-модерации) |


### Объект автора повязки
О пользователях подробнее в [другом разделе](/docs/users.md).

| Поле       | Описание                                    | Тип данных |
| ---------- | ------------------------------------------- | ---------- |
| `id`       | Id пользователя.                            | `string`   |
| `name`     | Глобальное имя пользователя.                | `string`   |
| `username` | Имя пользователя для URL.                   | `string`   |
| `public`   | Является ли профиль пользователя публичным. | `boolean`  |

### Объект модерации

| Поле         | Описание                                                    | Тип данных                         |
| ------------ | ----------------------------------------------------------- | ---------------------------------- |
| `type`       | Тип модерации (review / denied)                             | `string`                           |
| `message`    | Сообщение модерации.                                        | `string`                           |
| `is_hides`   | Скрывает ли данное состояние модерации работу из мастерской | `boolean`                          |
| `issuer`     | Кто создал это состояние модерации                          | [`Author`](#объект-автора-повязки) |
| `issue_date` | Дата создания состояния модерации                           | `Date` as string                   |

<details>
  <summary>Пример JSON ответа</summary>

  ```json
{
    "data": [
        {
            "id": 529,
            "external_id": "vehwm5",
            "title": "Повязка в виде игрока Just_S",
            "description": "Чорт, программист, ГНДРовец",
            "base64": "<b64>",
            "flags": 2,
            "accent_color": "#737473",
            "creation_date": "2025-07-04T19:00:10.223Z",
            "stars_count": 3,
            "tags": [
                "Именные",
                "Ютубер",
                "Майншилд"
            ],
            "author": {
                "id": "236188357351178344",
                "name": "Vakenak",
                "username": "vakenak_d",
                "public": true
            },
            "access_level": 2,
            "star_type": 0,
            "moderation": null
        }
    ],
    "totalCount": 41,
    "next_page": 2
}
```
</details>

---

## `POST /workshop`
<sub>Strict Auth required</sub>  
Создает новую работу в мастерской.

> [!NOTE]
> Данный эндпоинт доступен только авторизованным пользователям!

Все повязки, создаваемые пользователем, автоматически получают статус модерации `На проверке`, который исключает её из мастерской до момента одобрения. **Один пользователь может иметь только 5 одновременных повязок на проверке!** Общих ограничений по количеству нет.

### Тело запроса
| Поле          | Описание                                                                                          | Тип данных | Обязательный | Ограничения               |
| ------------- | ------------------------------------------------------------------------------------------------- | ---------- | :----------: | ------------------------- |
| `base64`      | Повязка в формате `Base 64`.                                                                      | `string`   |      Да      | -                         |
| `base64_slim` | Повязка в формате `Base 64` для тонких рук. Обрабатывается только когда `split_type` равен `true` | `string`   |     Нет      | -                         |
| `title`       | Заголовок повязки                                                                                 | `string`   |      Да      | Длина от 1 до 50 символов |
| `description` | Описание повязки                                                                                  | `string`   |     Нет      | Длина до 300 символов     |
| `tags`        | Массив имен тегов                                                                                 | `string[]` |      Да      | Максимум 10 тегов         |
| `split_type`  | Использовать ли разные повязки для разных типов рук. Делает параметр `base64_slim` обязательным   | `boolean`  |     Нет      | -                         |
| `colorable`   | Должна ли повязка быть окрашиваемой                                                               | `boolean`  |      Да      | -                         |

### Особенности
Если параметр `split_type` равен `true`, то поле `base64_slim` должно быть представлено в теле запроса. Так же в таком случае изображения повязок должны быть равны по высоте.

Любая повязка должна иметь ширину в `16` пикселей и чётную высоту от `2` до `24`.

### Возвращаемое значение
При удачном создании повязки, сервер вернёт HTTP код `201` и тело ответа:

| Поле          | Описание           | Тип данных |
| ------------- | ------------------ | ---------- |
| `external_id` | Внешний id повязки | `string`   |

<details>
  <summary>Пример JSON ответа</summary>

  ```json
{
    "external_id": "vehwm5"
}
```
</details>

---

## `GET /workshop/<external_id>`
Получить объект повязки.

### Возвращаемое значение
| Поле                | Описание                                                        | Тип данных                                |
| ------------------- | --------------------------------------------------------------- | ----------------------------------------- |
| `id`                | Внутренний инкрементальный id повязки в базе данных.            | `number`                                  |
| `external_id`       | Внешний id повязки. Используется в URL.                         | `string`                                  |
| `title`             | Заголовок повязки.                                              | `string`                                  |
| `description`       | Описание повязки.                                               | `string \| null`                          |
| `base64`            | Изображение повязки в формате `Base 64`.                        | `string`                                  |
| `base64_slim`       | Изображение для тонких рук (если split_type в flags)            | `string \| undefined`                     |
| `flags`             | Битовая маска характеристик ([подробнее](#битовые-флаги-flags)) | `number`                                  |
| `creation_date`     | Время создания повязки.                                         | `Date` as string                          |
| `stars_count`       | Количество пользователей, добавивших повязку в избранное        | `number`                                  |
| `author`            | Профиль автора повязки.                                         | [`Author`](#объект-автора-повязки)        |
| `tags`              | Массив имен тегов повязки.                                      | `string[]`                                |
| `permissions_level` | Уровень доступа при редактировании.                             | `number`                                  |
| `access_level`      | Общий уровень доступа к повязке в мастерской.                   | `number`                                  |
| `accent_color`      | Акцентный цвет повязки в формате HEX                            | `string`                                  |
| `moderation`        | Состояние модерации                                             | [`Moderation \| null`](#объект-модерации) |
| `star_type`         | Тип звезды, отображаемый в мастерской                           | `number`                                  |
| `views`             | Количество просмотров повязки                                   | `number`                                  |

`permissions_level` показывает, какие действия пользователь может совершать с повязкой:
- `0` — Пользователь не является владельцем повязки, а так же админом.
- `1` — Пользователь является владельцем повязки, но она уже прошла модерацию. У него есть доступ к удалению, изменению тегов и уровня доступа.
- `2` — Пользователь является админом с ролью `ManageBandages` или владельцем повязки во время модерации. Возможно совершать любое действие с повязкой.

`access_level` показывает, кто и как может получить доступ к повязке:
- `0` — Доступ имеют только владелец и администраторы с правом `ManageBandages`
- `1` — Доступ есть у всех, у кого есть ссылка. В мастерской эта повязка не видна.
- `2` — Повязка отображается в мастерской.

<details>
  <summary>Пример JSON ответа</summary>

  ```json
{
    "data": {
        "id": 69,
        "external_id": "coolid",
        "title": "Повязка",
        "description": "Описание",
        "base64": "base64",
        "base64_slim": undefined,
        "flags": 1,
        "creation_date": "2023-07-26T15:55:00.000Z",
        "stars_count": 1,
        "author": {
            "id": "1",
            "name": "AndcoolSystems",
            "username": "andcoolsystems",
            "public": true
        },
        "tags": ["Официальные", "Тематические"],
        "permissions_level": 2,
        "access_level": 2,
        "accent_color": "#737473",
        "moderation": null,
        "star_type": 0,
        "views": 150
    }
}
  ```
</details>

---

## `GET /workshop/<external_id>/info`
Возвращает основную информацию о повязке. Используется для генерации Open Graph.
Доступ к этому эндпоинту можно получить только передав `Unique-Access` хедер в запрос, содержащий токен доступа. Токен не разглашается.

### Возвращаемое значение
| Поле               | Описание                                                 | Тип данных                         |
| ------------------ | -------------------------------------------------------- | ---------------------------------- |
| `id`               | Внутренний инкрементальный id повязки в базе данных.     | `number`                           |
| `external_id`      | Внешний id повязки. Используется в URL.                  | `string`                           |
| `title`            | Заголовок повязки.                                       | `string`                           |
| `description`      | Описание повязки.                                        | `string \| null`                   |
| `stars_count`      | Количество пользователей, добавивших повязку в избранное | `number`                           |
| `average_og_color` | Средний цвет повязки в формате HEX                       | `string`                           |
| `author`           | Профиль автора повязки.                                  | [`Author`](#объект-автора-повязки) |

<details>
  <summary>Пример JSON ответа</summary>

  ```json
{
    "data": {
        "id": 69,
        "external_id": "coolid",
        "title": "Повязка",
        "description": "Описание",
        "average_og_color": "#b46691",
        "stars_count": 1,
        "author": {
            "id": "1",
            "name": "AndcoolSystems",
            "username": "andcoolsystems",
            "public": true
        }
    }
}
  ```
</details>

---

## `GET /workshop/<external_id>/og`
**`GET /workshop/<external_id>/as_image`** (Deprecated)
`Content-Type: image/png`
Возвращает изображение-превью повязки (thumbnail) для Open Graph.

### Query параметры
| Имя     | Описание                    | Тип данных | Стандартное значение |
| ------- | --------------------------- | ---------- | -------------------- |
| `token` | Токен доступа (опционально) | `string`   | -                    |

---

## `POST /workshop/:id/view`
Добавляет просмотр повязке. Внутренний эндпоинт для локальных запросов.

> [!NOTE]
> Доступ к этому эндпоинту имеют только локальные запросы (внутренние сервисы).

### Ограничения
- **1 запрос в минуту на уникальный IP + ID повязки**

---

## `PUT /workshop/:id/archive`
<sub>Strict Auth required</sub>  
Архивирует повязку. Пользователь должен быть владельцем или администратором.

### URL параметры
| Имя  | Описание            | Тип данных |
| ---- | ------------------- | ---------- |
| `id` | External ID повязки | `string`   |

### Особенности
Архивирование скрывает повязку из мастерской, но не удаляет её полностью. Повязка остается доступной по прямой ссылке.

---

## `GET /workshop/moderation`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageBandages</sub>  
Получить список повязок на модерации.

### Тело ответа
Возвращает массив объектов повязок, которые находятся на проверке. Структура объектов идентична [GET /workshop](#get-workshop).

---

## `GET /workshop/tags/suggest`
Поиск тегов по запросу (автодополнение).

### Query параметры
| Имя | Описание            | Тип данных | Стандартное значение |
| --- | ------------------- | ---------- | -------------------- |
| `q` | Фрагмент имени тега | `string`   | `""`                 |

### Тело ответа
Массив строк с именами тегов:

```json
[
    "Именные",
    "Ютубер",
    "Майншилд"
]
```

---

## `PUT /workshop/:id/moderation`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageBandages</sub>  
Изменить статус модерации повязки.

### Тело запроса
| Поле       | Описание                              | Тип данных | Обязательный |
| ---------- | ------------------------------------- | ---------- | :----------: |
| `type`     | Тип модерации (`review` или `denied`) | `string`   |      Да      |
| `message`  | Сообщение модератора                  | `string`   |      Да      |
| `is_final` | Финальное ли это решение              | `boolean`  |      Да      |
| `is_hides` | Скрывать ли повязку из мастерской     | `boolean`  |      Да      |

### Особенности
- `type: 'review'` - повязка отправлена на проверку
- `type: 'denied'` - повязка отклонена
- `type: 'none'` - повязка одобрена (удаляет состояние модерации)
- `is_final: true` - решение окончательное, повязка не может быть повторно отправлена на модерацию
- `is_hides: true` - повязка будет скрыта из публичной мастерской

---

## `GET /workshop/count/badge`
Получить количество повязок для shields.io badge.

### Тело ответа
```json
{
    "schemaVersion": 1,
    "label": "Bandages Count",
    "message": "1234",
    "color": "green"
}
```

---

## `PUT /workshop/star/<external_id>`
<sub>Strict Auth required</sub>  
Добавляет/удаляет повязку в избранное.

### Query параметры
| Имя   | Описание                                    | Тип данных |
| ----- | ------------------------------------------- | ---------- |
| `set` | Добавить или удалить повязку из избранного. | `boolean`  |

### Тело ответа
```json
{
    "new_count": 42,
    "action_set": true
}
```

- `new_count` - новое количество звёзд у повязки
- `action_set` - было ли выполнено добавление (true) или удаление (false)

---

## `PUT /workshop/<external_id>`
<sub>Strict Auth required</sub>  
Обновляет повязку.

### Тело запроса
| Поле           | Описание                   | Тип данных | Обязательный | Ограничения               |
| -------------- | -------------------------- | ---------- | :----------: | ------------------------- |
| `title`        | Заголовок повязки.         | `string`   |      Да      | Длина от 1 до 50 символов |
| `description`  | Описание повязки           | `string`   |     Нет      | Длина до 300 символов     |
| `tags`         | Массив имен тегов.         | `string[]` |     Нет      | Максимум 10 тегов         |
| `access_level` | Уровень доступа к повязке. | `number`   |     Нет      | 0, 1 или 2                |
| `colorable`    | Окрашиваемая ли повязка    | `boolean`  |     Нет      | -                         |

### Особенности
После прохождения модерации, изменение заголовка, описания и тегов повязки приведет к ее отправке на ремодерацию.

---

## `DELETE /workshop/<external_id>`
<sub>Strict Auth required</sub>  
Удаляет повязку. Пользователь должен быть владельцем повязки или администратором.
