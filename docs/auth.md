# Аутентификация
**API для авторизации через различные OAuth провайдеры.**

---

## Поддерживаемые провайдеры

API поддерживает следующие методы авторизации:
- **Discord** - OAuth 2.0
- **Google** - OAuth 2.0
- **Twitch** - OAuth 2.0
- **Telegram** - Telegram Login Widget
- **Minecraft** - Собственная система авторизации

---

## Процесс авторизации

Общий процесс авторизации для всех провайдеров:

1. Получить URL авторизации через эндпоинт `GET /auth/url/<provider>`
2. Перенаправить пользователя на полученный URL
3. Пользователь авторизуется у провайдера
4. Провайдер перенаправляет пользователя обратно с authorization code
5. Отправить code на эндпоинт `POST /auth/<provider>`
6. Получить session token в ответе и в `SetCookie` заголовке

---

## `POST /auth/discord`
Создает сессию для пользователя через Discord OAuth.

### Тело запроса
| Поле   | Описание                              | Тип данных | Обязательный |
| ------ | ------------------------------------- | ---------- | :----------: |
| `code` | Authorization code от Discord         | `string`   |      Да      |

### Тело ответа
```json
{
    "session": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### Заголовки ответа
- `SetCookie` - содержит sessionId cookie со временем жизни 14 дней

---

## `POST /auth/google`
Создает сессию для пользователя через Google OAuth.

### Тело запроса
| Поле   | Описание                       | Тип данных | Обязательный |
| ------ | ------------------------------ | ---------- | :----------: |
| `code` | Authorization code от Google   | `string`   |      Да      |

### Тело ответа
```json
{
    "session": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

## `POST /auth/twitch`
Создает сессию для пользователя через Twitch OAuth.

### Тело запроса
| Поле   | Описание                      | Тип данных | Обязательный |
| ------ | ----------------------------- | ---------- | :----------: |
| `code` | Authorization code от Twitch  | `string`   |      Да      |

### Тело ответа
```json
{
    "session": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

## `POST /auth/telegram`
Создает сессию для пользователя через Telegram.

### Тело запроса
| Поле   | Описание                        | Тип данных | Обязательный |
| ------ | ------------------------------- | ---------- | :----------: |
| `code` | Authorization code от Telegram  | `string`   |      Да      |

### Тело ответа
```json
{
    "session": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

## `POST /auth/minecraft`
Создает сессию для пользователя через Minecraft авторизацию.

### Тело запроса
| Поле   | Описание                         | Тип данных | Обязательный |
| ------ | -------------------------------- | ---------- | :----------: |
| `code` | Authorization code от Minecraft  | `string`   |      Да      |

### Тело ответа
```json
{
    "session": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

## `GET /auth/url/discord`
Перенаправляет на страницу авторизации Discord.

### Query параметры
| Имя       | Описание                                                      | Тип данных |
| --------- | ------------------------------------------------------------- | ---------- |
| `connect` | Если `true`, используется redirect URL для подключения аккаунта | `boolean`  |

### Ответ
- **Redirect 302** на Discord OAuth URL

---

## `GET /auth/url/google`
Перенаправляет на страницу авторизации Google.

### Query параметры
| Имя       | Описание                                                      | Тип данных |
| --------- | ------------------------------------------------------------- | ---------- |
| `connect` | Если `true`, используется redirect URL для подключения аккаунта | `boolean`  |

### Ответ
- **Redirect 302** на Google OAuth URL

---

## `GET /auth/url/twitch`
Перенаправляет на страницу авторизации Twitch.

### Query параметры
| Имя       | Описание                                                      | Тип данных |
| --------- | ------------------------------------------------------------- | ---------- |
| `connect` | Если `true`, используется redirect URL для подключения аккаунта | `boolean`  |

### Ответ
- **Redirect 302** на Twitch OAuth URL

---

## `GET /auth/url/telegram`
Перенаправляет на страницу авторизации Telegram.

### Query параметры
| Имя       | Описание                                                      | Тип данных |
| --------- | ------------------------------------------------------------- | ---------- |
| `connect` | Если `true`, используется redirect URL для подключения аккаунта | `boolean`  |

### Ответ
- **Redirect 302** на Telegram Login URL

---

## Управление сессиями

После авторизации токен сессии автоматически управляется:

- **Время жизни**: 14 дней (configurable via `SESSION_TTL`)
- **Автообновление**: если прошло более 50% времени жизни токена
- **Fingerprint**: сессия привязана к User-Agent, смена браузера инвалидирует токен
- **Роли доступа**: закодированы в JWT как битовые маски

> [!WARNING]
> Бекенд не поддерживает параллельные запросы при обновлении токена. Клиенты должны сериализовать запросы, которые могут вызвать обновление токена.

Подробнее об управлении сессиями см. в разделе [Пользователи - Сессии](/docs/users.md#сессии).
