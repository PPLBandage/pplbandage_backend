# Административные эндпоинты
**API для административного управления системой.**

> [!WARNING]
> Все эндпоинты этого раздела требуют строгой авторизации и специальные права доступа (роли).

---

## Система ролей

PPLBandage использует битовую систему ролей для управления доступом:

| Роль             | Описание                               |
| ---------------- | -------------------------------------- |
| `SuperAdmin`     | Полный доступ ко всем функциям системы |
| `ManageBandages` | Управление повязками и модерация       |
| `ManageKV`       | Управление хранилищем ключ-значение    |
| `ManageEvents`   | Управление событиями (буст тегов)      |
| `UpdateUsers`    | Редактирование пользователей           |

Роли проверяются через декоратор `@Roles([RolesEnum.RoleName])` в контроллерах.

---

## Статистика

### `GET /admin`
<sub>Strict Auth required</sub>  
<sub>Requires role: SuperAdmin</sub>  
Получить общую статистику системы.

### Тело ответа
```json
{
    "users_data": {
        "users_count": 1234,
        "first_reg": {
            "date": "2023-01-15T10:30:00.000Z",
            "name": "FirstUser"
        },
        "last_reg": {
            "date": "2025-12-01T14:20:00.000Z",
            "name": "LastUser"
        },
        "activity_period": 694.5,
        "unique_reg_days": 456,
        "avg_reg": 2.7,
        "top_day": {
            "day": "2024-01-15",
            "registrations": 42
        }
    }
}
```

**Описание полей:**
- `users_count` - Общее количество зарегистрированных пользователей
- `first_reg` - Первая регистрация (дата и имя пользователя)
- `last_reg` - Последняя регистрация (дата и имя пользователя)
- `activity_period` - Период активности регистраций в днях
- `unique_reg_days` - Количество уникальных дней с регистрациями
- `avg_reg` - Среднее количество регистраций в день
- `top_day` - День с максимальным количеством регистраций

---

## Key-Value хранилище

KV хранилище используется для хранения конфигурации, feature flags и других настроек системы.

### `GET /admin/kv`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageKV</sub>  
Получить все ключи и значения из хранилища.

### Тело ответа
```json
{
    "feature_new_ui": {
        "id": 1,
        "value": "true",
        "modified": "2025-01-20T12:00:00.000Z",
        "created": "2025-01-15T10:00:00.000Z"
    },
    "maintenance_mode": {
        "id": 2,
        "value": "false",
        "modified": "2025-01-18T09:30:00.000Z",
        "created": "2025-01-15T10:00:00.000Z"
    }
}
```

**Структура:** Объект, где ключи — это ключи из KV-хранилища, значения — объекты с метаданными.

**Описание полей:**
- `id` - ID записи в базе данных
- `value` - Значение ключа (строка)
- `modified` - Дата последнего изменения
- `created` - Дата создания записи

---

### `POST /admin/kv`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageKV</sub>  
Создать или обновить запись в KV хранилище.

### Тело запроса
| Поле    | Описание        | Тип данных | Обязательный |
| ------- | --------------- | ---------- | :----------: |
| `key`   | Ключ записи     | `string`   |      Да      |
| `value` | Значение записи | `string`   |      Да      |

### Особенности
Если ключ уже существует, его значение будет обновлено.

---

### `DELETE /admin/kv`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageKV</sub>  
Удалить запись из KV хранилища.

### Тело запроса
| Поле  | Описание          | Тип данных | Обязательный |
| ----- | ----------------- | ---------- | :----------: |
| `key` | Ключ для удаления | `string`   |      Да      |

---

## События (Events)

События используются для временного буста повязок с определенными тегами в мастерской. Например, новогоднее событие может повысить видимость повязок с тегом "Новый Год".

### `GET /admin/events`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageEvents</sub>  
Получить список всех событий.

### Тело ответа
```json
[
    {
        "id": 1,
        "name": "Новогоднее событие 2025",
        "start": "2024-12-25T00:00:00.000Z",
        "end": "2025-01-10T23:59:59.000Z",
        "boost_amount": 100,
        "tags": ["Новый Год", "Праздники"]
    },
    {
        "id": 2,
        "name": "Летнее событие",
        "start": "2025-06-01T00:00:00.000Z",
        "end": "2025-08-31T23:59:59.000Z",
        "boost_amount": 50,
        "tags": ["Лето", "Природа"]
    }
]
```

**Структура:** Массив объектов событий (без обёртки).

**Описание полей:**
- `id` - Уникальный идентификатор события
- `name` - Название события
- `start` - Дата и время начала события
- `end` - Дата и время окончания события
- `boost_amount` - Множитель буста (0-1000)
- `tags` - Массив названий тегов, к которым применяется буст

---

### `POST /admin/events`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageEvents</sub>  
Создать новое событие.

### Тело запроса
| Поле           | Описание                                     | Тип данных | Обязательный |
| -------------- | -------------------------------------------- | ---------- | :----------: |
| `name`         | Название события                             | `string`   |      Да      |
| `start_date`   | Дата и время начала события                  | `string`   |      Да      |
| `end_date`     | Дата и время окончания события               | `string`   |      Да      |
| `boost_amount` | Множитель буста (0-1000)                     | `number`   |      Да      |
| `tags`         | Массив названий тегов, к которым применяется буст | `string[]` |      Да      |

### Пример запроса
```json
{
    "name": "Летнее событие",
    "start_date": "2025-06-01T00:00:00Z",
    "end_date": "2025-08-31T23:59:59Z",
    "boost_amount": 50,
    "tags": ["Лето", "Природа", "Отдых"]
}
```

### Особенности
- `boost_amount` определяет насколько увеличивается relevance score повязок с указанными тегами
- События автоматически активируются/деактивируются в зависимости от текущей даты
- Одно событие может быть применено к нескольким тегам
- Теги передаются как массив строк (названия тегов), а не ID

---

### `PUT /admin/events`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageEvents</sub>  
Обновить существующее событие.

### Тело запроса
| Поле           | Описание                                     | Тип данных | Обязательный |
| -------------- | -------------------------------------------- | ---------- | :----------: |
| `id`           | ID события                                   | `number`   |      Да      |
| `name`         | Название события                             | `string`   |      Да      |
| `start_date`   | Дата и время начала события                  | `string`   |      Да      |
| `end_date`     | Дата и время окончания события               | `string`   |      Да      |
| `boost_amount` | Множитель буста (0-1000)                     | `number`   |      Да      |
| `tags`         | Массив названий тегов, к которым применяется буст | `string[]` |      Да      |

### Пример запроса
```json
{
    "id": 1,
    "name": "Обновленное летнее событие",
    "start_date": "2025-06-01T00:00:00Z",
    "end_date": "2025-09-01T23:59:59Z",
    "boost_amount": 75,
    "tags": ["Лето", "Природа", "Каникулы"]
}
```

### Особенности
- **Все поля обязательны** (включая `id`)
- Необходимо передать полный объект события со всеми полями
- Теги передаются как массив строк (названия тегов), а не ID

---

### `DELETE /admin/events`
<sub>Strict Auth required</sub>  
<sub>Requires role: ManageEvents</sub>  
Удалить событие.

### Тело запроса
| Поле | Описание   | Тип данных | Обязательный |
| ---- | ---------- | ---------- | :----------: |
| `id` | ID события | `number`   |      Да      |

### Особенности
Удаление события автоматически убирает буст со всех связанных повязок.

---

## Управление пользователями

Административные функции для управления пользователями находятся в модуле Users:

- **PATCH /users/:username** - Редактирование пользователя (требует роль `UpdateUsers`)
- **GET /users/** - Список всех пользователей (требует роль `UpdateUsers`)

Подробнее см. [Документацию пользователей](/docs/users.md#административные-функции).

---

## Модерация повязок

Административные функции для модерации повязок находятся в модуле Workshop:

- **GET /workshop/moderation** - Список повязок на модерации (требует роль `ManageBandages`)
- **PUT /workshop/:id/moderation** - Изменение статуса модерации (требует роль `ManageBandages`)

Подробнее см. [Документацию мастерской](/docs/workshop.md#модерация).

---

## Безопасность

> [!IMPORTANT]
> - Все административные действия логируются
> - Доступ к административным эндпоинтам проверяется на уровне guards
> - Роли хранятся в JWT токене и проверяются при каждом запросе
> - Неавторизованные попытки доступа возвращают HTTP 403 (Forbidden)
